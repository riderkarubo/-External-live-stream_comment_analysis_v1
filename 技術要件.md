# ライブ配信チャット分析ツール - 技術要件書

## 1. アプリケーション概要

ライブ配信のチャット（コメント）CSVデータをアップロードし、AIを活用してコメントを分析し、Googleスプレッドシートに結果を出力するWebアプリケーション。

### 主要機能

- CSVファイルのアップロードとデータ抽出
- AIによるコメント属性・感情分析
- Googleスプレッドシートへの結果出力（2シート構成）
- 統計情報の可視化

## 2. 技術スタック

### フロントエンド/バックエンド

- **Streamlit**: PythonベースのWebアプリケーションフレームワーク
- **Python 3.8+**: メインプログラミング言語

### 主要ライブラリ

- **pandas**: CSVデータの処理・操作
- **google-api-python-client**: GoogleスプレッドシートAPI
- **google-auth**: Google認証
- **anthropic**: Anthropic Claude APIクライアント
- **python-dotenv**: 環境変数管理

### 外部API/サービス

- **Anthropic Claude API**: コメント分析（属性・感情判定）
- **Google Sheets API**: スプレッドシート作成・編集

## 3. 機能要件

### 3.1 データ入力

- CSVファイルアップロード機能
- 必要な列の抽出: `guest_id`, `username`, `original_text`, `inserted_at`
- データバリデーション

### 3.2 データ処理

- `inserted_at`の時間順ソート（早い順）
- `inserted_at`を相対時間表示に変換（00:00:00形式）
  - 最初のコメントの時刻を00:00:00として正規化
  - その後のコメントは最初のコメントからの経過時間で表示（時:分:秒形式、HH:MM:SS）
  - 例：最初のコメントが10:00:00の場合、それを00:00:00に変換し、11:15:00のコメントは01:15:00として表示
  - 最終コメントの時刻も相対時間で表示（例：配信開始から1時間15分後なら01:15:00）
- AIによるコメント属性判定（8種類）
- AIによる感情分析（4種類）
- 質問コメントの抽出

### 3.3 Googleスプレッドシート出力

#### メインシート

- 全コメントデータ表示
- ドロップダウン形式の列:
  - `username`（色分けなし）
  - `チャットの属性`（色分けあり）
  - `チャット感情`（色分けあり）
- 上部に統計情報表示:
  - 全コメント件数
  - 各チャット属性の件数
  - 各チャット感情の件数

#### 質問シート

- 質問コメントのみ抽出
- `回答状況`列を追加（ドロップダウン、色分けあり）
- 上部に統計情報表示:
  - 質問コメント件数
  - 質問回答率（%）

### 3.4 AI分析仕様

#### チャットの属性（8種類）

1. 公式コメント
2. 商品に対する質問
3. 出演者に対する質問
4. 商品に対するリアクション
5. 出演者に対するリアクション
6. 商品と出演者に対するリアクション
7. 公式コメント（usernameがStarbucks Japan）
8. その他（絵文字など）

#### チャット感情（4種類）

1. ポジティブ
2. ネガティブ
3. 混在
4. どちらでもない

#### 回答状況（3種類）

1. 出演者
2. 運営
3. 未回答

## 4. 非機能要件

### 4.1 セキュリティ

- APIキーの環境変数管理（.envファイル）
- Googleサービスアカウント認証

### 4.2 パフォーマンス

- 大量のコメントデータに対応可能な設計
- API呼び出しの適切なレート制限対応

### 4.3 ユーザビリティ

- 直感的なUI
- 処理進捗の可視化
- エラーハンドリングとメッセージ表示

## 5. データフロー

```
1. ユーザーがCSVファイルをアップロード
   ↓
2. CSVから必要な列を抽出・検証
   ↓
3. inserted_atでソート
   ↓
4. inserted_atを相対時間に変換（最初のコメントを00:00:00に）
   ↓
5. 各コメントに対してAI分析（属性・感情）
   ↓
6. 質問コメントを抽出
   ↓
7. Googleスプレッドシートを作成
   ↓
8. メインシートに全データを書き込み（色分け・ドロップダウン設定）
   ↓
9. 質問シートに質問コメントを書き込み
   ↓
10. 統計情報を計算してシート上部に表示
   ↓
11. スプレッドシートURLをユーザーに提供
```

## 6. ファイル構成

```
live-stream_comment_analysis/
├── README.md
├── requirements.txt
├── .env.example
├── .gitignore
├── app.py                    # Streamlitメインアプリ
├── config.py                 # 設定管理
├── utils/
│   ├── csv_processor.py      # CSV処理
│   ├── ai_analyzer.py        # AI分析
│   └── google_sheets.py      # スプレッドシート操作
└── prompts/
    └── analysis_prompts.py   # AI分析用プロンプト
```

## 7. セットアップ要件

### 7.1 必要な環境変数

- `ANTHROPIC_API_KEY`: Anthropic Claude APIキー
- `GOOGLE_SERVICE_ACCOUNT_FILE`: サービスアカウントJSONファイルパス
- または `GOOGLE_CREDENTIALS_JSON`: 認証情報JSON文字列

### 7.2 Google Cloud設定

- Google Cloud プロジェクトの作成
- Google Sheets APIの有効化
- サービスアカウントの作成と認証情報の取得

## 8. 将来の拡張性

- 企業名選択機能の追加（現在はStarbucks Japan固定）
- 分析ルールのカスタマイズ機能
- 複数のCSVファイル一括処理
- 分析結果のエクスポート機能（CSV、Excelなど）

## 9. 確認事項

### 9.1 実装前に確認が必要な項目

- Googleスプレッドシートの共有設定（サービスアカウントのメールアドレスを共有する必要があるか）
- AI分析の精度要件（試行錯誤が必要な可能性）
- 大量データ（10,000件以上）への対応方針

### 9.2 開発の優先順位

1. CSVアップロードとデータ抽出
2. 基本的なAI分析機能
3. Googleスプレッドシート出力
4. ドロップダウンと色分け機能
5. 統計情報の表示
6. UI/UXの改善


